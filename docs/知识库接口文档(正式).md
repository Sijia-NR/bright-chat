# 知识库模块接口文档

> **版本**: v1.0.0
> **更新日期**: 2026-01-29
> **基础路径**: `/api/v1/knowledge`

---

## 目录

- [概述](#概述)
- [认证说明](#认证说明)
- [通用参数](#通用参数)
- [接口列表](#接口列表)
  - [知识库分组管理](#1-知识库分组管理)
  - [知识库管理](#2-知识库管理)
  - [文档管理](#3-文档管理)
  - [切片管理](#4-切片管理)
  - [知识检索](#5-知识检索)
- [数据模型](#数据模型)
- [错误码说明](#错误码说明)
- [使用示例](#使用示例)

---

## 概述

知识库模块提供了完整的文档管理、向量化和语义检索功能，支持多种文档格式的上传、自动分块、向量化存储，以及基于向量相似度的智能检索。

### 主要功能

- **知识库分组管理**: 创建、查询、删除知识库分组
- **知识库管理**: 创建、查询、更新、删除知识库
- **文档上传与处理**: 支持多种格式的文档上传、自动分块、向量化
- **语义检索**: 基于向量相似度的智能知识检索
- **切片管理**: 查询文档的切片详情（支持分页）

### 技术架构

- **向量数据库**: ChromaDB (端口 8002)
- **向量化模型**: BGE-large-zh-v1.5 (1024维)
- **文本分割**: RecursiveCharacterTextSplitter
- **相似度计算**: Cosine Similarity

---

## 认证说明

所有接口（除健康检查外）均需要 JWT 认证。

### 请求头格式

```http
Authorization: Bearer <your_jwt_token>
```

### 获取 Token

通过登录接口获取：

```bash
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "pwd123"
}
```

响应：

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "id": "user-id",
  "username": "admin",
  "role": "admin"
}
```

---

## 通用参数

### 分页参数

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `offset` | int | 否 | 0 | 偏移量 |
| `limit` | int | 否 | 无 | 返回数量限制 |

### 时间格式

所有时间字段使用 ISO 8601 格式：

```json
"created_at": "2026-01-29T10:30:00"
```

### ID 格式

所有资源 ID 使用 UUID v4 格式：

```json
"id": "550e8400-e29b-41d4-a716-446655440000"
```

---

## 接口列表

### 1. 知识库分组管理

#### 1.1 创建知识库分组

创建一个新的知识库分组，用于组织和管理知识库。

**端点**: `POST /api/v1/knowledge/groups`

**权限要求**: 已登录用户

**请求参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `name` | string | 是 | 分组名称（1-255字符） |
| `description` | string | 否 | 分组描述 |
| `color` | string | 否 | 分组颜色（十六进制，默认#3B82F6） |

**请求示例**:

```json
{
  "name": "技术文档",
  "description": "包含所有技术相关的文档",
  "color": "#3B82F6"
}
```

**响应示例**:

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "技术文档",
  "description": "包含所有技术相关的文档",
  "user_id": "user-id-123",
  "color": "#3B82F6",
  "created_at": "2026-01-29T10:30:00"
}
```

**错误响应**:

- `400`: 分组名称已存在
- `401`: 未认证

---

#### 1.2 获取知识库分组列表

获取当前用户的所有知识库分组。

**端点**: `GET /api/v1/knowledge/groups`

**权限要求**: 已登录用户

**查询参数**: 无

**响应示例**:

```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "技术文档",
    "description": "包含所有技术相关的文档",
    "user_id": "user-id-123",
    "color": "#3B82F6",
    "created_at": "2026-01-29T10:30:00"
  },
  {
    "id": "660e8400-e29b-41d4-a716-446655440001",
    "name": "产品文档",
    "description": "产品说明和用户手册",
    "user_id": "user-id-123",
    "color": "#10B981",
    "created_at": "2026-01-28T15:20:00"
  }
]
```

**说明**: 结果按创建时间倒序排列。

---

#### 1.3 删除知识库分组

删除指定的知识库分组（级联删除分组下的所有知识库）。

**端点**: `DELETE /api/v1/knowledge/groups/{group_id}`

**权限要求**: 已登录用户（仅限分组创建者）

**路径参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| `group_id` | string | 分组 ID |

**响应示例**:

```json
{
  "message": "分组已删除"
}
```

**错误响应**:

- `403`: 无权限删除此分组
- `404`: 分组不存在

---

### 2. 知识库管理

#### 2.1 创建知识库

创建一个新的知识库。

**端点**: `POST /api/v1/knowledge/bases`

**权限要求**: 已登录用户

**请求参数**:

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `name` | string | 是 | - | 知识库名称（1-255字符） |
| `description` | string | 否 | - | 知识库描述 |
| `group_id` | string | 否 | null | 所属分组 ID（可为空，创建独立知识库） |
| `embedding_model` | string | 否 | bge-large-zh-v1.5 | 向量化模型 |
| `chunk_size` | int | 否 | 500 | 文本分块大小（100-2000） |
| `chunk_overlap` | int | 否 | 50 | 分块重叠大小（0-500） |

**请求示例**:

```json
{
  "name": "Python 入门指南",
  "description": "Python 编程基础知识",
  "group_id": "550e8400-e29b-41d4-a716-446655440000",
  "embedding_model": "bge-large-zh-v1.5",
  "chunk_size": 500,
  "chunk_overlap": 50
}
```

**响应示例**:

```json
{
  "id": "770e8400-e29b-41d4-a716-446655440002",
  "name": "Python 入门指南",
  "description": "Python 编程基础知识",
  "user_id": "user-id-123",
  "group_id": "550e8400-e29b-41d4-a716-446655440000",
  "embedding_model": "bge-large-zh-v1.5",
  "chunk_size": 500,
  "chunk_overlap": 50,
  "is_active": true,
  "document_count": 0,
  "created_at": "2026-01-29T10:35:00",
  "updated_at": "2026-01-29T10:35:00"
}
```

**错误响应**:

- `400`: 知识库名称已存在 / 参数验证失败
- `404`: 分组不存在（如果指定了 group_id）

---

#### 2.2 获取知识库列表

获取当前用户的所有知识库。

**端点**: `GET /api/v1/knowledge/bases`

**权限要求**: 已登录用户

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `group_id` | string | 否 | 筛选指定分组的知识库 |

**响应示例**:

```json
[
  {
    "id": "770e8400-e29b-41d4-a716-446655440002",
    "name": "Python 入门指南",
    "description": "Python 编程基础知识",
    "user_id": "user-id-123",
    "group_id": "550e8400-e29b-41d4-a716-446655440000",
    "embedding_model": "bge-large-zh-v1.5",
    "chunk_size": 500,
    "chunk_overlap": 50,
    "is_active": true,
    "document_count": 5,
    "created_at": "2026-01-29T10:35:00",
    "updated_at": "2026-01-29T10:35:00"
  }
]
```

**说明**: 结果按创建时间倒序排列，`document_count` 为已处理完成的文档数量。

---

#### 2.3 获取知识库详情

获取指定知识库的详细信息。

**端点**: `GET /api/v1/knowledge/bases/{kb_id}`

**权限要求**: 已登录用户（仅限知识库创建者）

**路径参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| `kb_id` | string | 知识库 ID |

**响应示例**:

```json
{
  "id": "770e8400-e29b-41d4-a716-446655440002",
  "name": "Python 入门指南",
  "description": "Python 编程基础知识",
  "user_id": "user-id-123",
  "group_id": "550e8400-e29b-41d4-a716-446655440000",
  "embedding_model": "bge-large-zh-v1.5",
  "chunk_size": 500,
  "chunk_overlap": 50,
  "is_active": true,
  "document_count": 5,
  "created_at": "2026-01-29T10:35:00",
  "updated_at": "2026-01-29T10:35:00"
}
```

**错误响应**:

- `403`: 无权限访问此知识库
- `404`: 知识库不存在

---

#### 2.4 更新知识库

更新指定知识库的信息。

**端点**: `PUT /api/v1/knowledge/bases/{kb_id}`

**权限要求**: 已登录用户（仅限知识库创建者）

**路径参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| `kb_id` | string | 知识库 ID |

**请求参数** (所有字段可选):

| 参数 | 类型 | 说明 |
|------|------|------|
| `name` | string | 知识库名称 |
| `description` | string | 知识库描述 |
| `group_id` | string | 所属分组 ID |
| `is_active` | boolean | 是否启用 |

**请求示例**:

```json
{
  "name": "Python 完整指南",
  "description": "Python 编程从入门到精通",
  "is_active": true
}
```

**响应示例**:

```json
{
  "id": "770e8400-e29b-41d4-a716-446655440002",
  "name": "Python 完整指南",
  "description": "Python 编程从入门到精通",
  "user_id": "user-id-123",
  "group_id": "550e8400-e29b-41d4-a716-446655440000",
  "embedding_model": "bge-large-zh-v1.5",
  "chunk_size": 500,
  "chunk_overlap": 50,
  "is_active": true,
  "document_count": 5,
  "created_at": "2026-01-29T10:35:00",
  "updated_at": "2026-01-29T11:00:00"
}
```

---

#### 2.5 删除知识库

删除指定的知识库（级联删除所有文档和向量数据）。

**端点**: `DELETE /api/v1/knowledge/bases/{kb_id}`

**权限要求**: 已登录用户（仅限知识库创建者）

**路径参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| `kb_id` | string | 知识库 ID |

**响应示例**:

```json
{
  "message": "知识库已删除"
}
```

**说明**: 此操作会同时删除 MySQL 数据库记录和 ChromaDB 向量数据。

---

### 3. 文档管理

#### 3.1 上传文档

上传文档到指定知识库，支持同步和异步两种处理模式。

**端点**: `POST /api/v1/knowledge/bases/{kb_id}/documents`

**权限要求**: 已登录用户（仅限知识库创建者）

**路径参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| `kb_id` | string | 知识库 ID |

**请求参数** (multipart/form-data):

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `file` | File | 是 | - | 文档文件 |
| `sync` | boolean | 否 | false | 是否同步处理（true=立即完成，false=后台任务） |
| `chunk_size` | int | 否 | 500 | 文本分块大小（覆盖知识库配置） |
| `chunk_overlap` | int | 否 | 50 | 分块重叠大小（覆盖知识库配置） |

**支持的文件格式**:

| 类型 | 扩展名 | 说明 |
|------|--------|------|
| PDF | `.pdf` | Adobe PDF 文档 |
| Word | `.doc`, `.docx` | Microsoft Word 文档 |
| Text | `.txt`, `.md`, `.markdown` | 纯文本和 Markdown |
| HTML | `.html`, `.htm` | HTML 网页 |
| Excel | `.xls`, `.xlsx` | Microsoft Excel 表格 |
| PowerPoint | `.ppt`, `.pptx` | Microsoft PowerPoint 演示文稿 |

**文件大小限制**: 最大 50MB

**请求示例** (cURL):

```bash
curl -X POST \
  http://localhost:18080/api/v1/knowledge/bases/{kb_id}/documents \
  -H "Authorization: Bearer <token>" \
  -F "file=@/path/to/document.pdf" \
  -F "sync=true" \
  -F "chunk_size=500"
```

**同步模式响应** (`sync=true`):

```json
{
  "id": "880e8400-e29b-41d4-a716-446655440003",
  "knowledge_base_id": "770e8400-e29b-41d4-a716-446655440002",
  "filename": "Python基础教程.pdf",
  "file_type": "pdf",
  "file_size": 1048576,
  "chunk_count": 42,
  "upload_status": "completed",
  "error_message": null,
  "uploaded_at": "2026-01-29T10:40:00",
  "processed_at": "2026-01-29T10:40:15"
}
```

**异步模式响应** (`sync=false`):

```json
{
  "id": "880e8400-e29b-41d4-a716-446655440003",
  "knowledge_base_id": "770e8400-e29b-41d4-a716-446655440002",
  "filename": "Python基础教程.pdf",
  "file_type": "pdf",
  "file_size": 1048576,
  "chunk_count": 0,
  "upload_status": "processing",
  "error_message": null,
  "uploaded_at": "2026-01-29T10:40:00",
  "processed_at": null
}
```

**处理流程**:

1. **文件验证**: 检查文件类型、大小、魔术字节
2. **文档解析**: 根据文件类型选择合适的加载器
3. **文本分割**: 使用 RecursiveCharacterTextSplitter 分块
4. **向量化**: 使用 BGE 模型生成向量（每批 32 个文档）
5. **向量存储**: 存储到 ChromaDB（每批 50 个向量）
6. **状态更新**: 更新数据库中的处理状态

**错误响应**:

- `400`: 不支持的文件类型 / 文件大小超限 / 参数验证失败
- `403`: 无权限访问此知识库
- `404`: 知识库不存在
- `413`: 文件大小超过 50MB 限制
- `500`: 文档处理失败（详见 error_message）

**状态说明**:

| 状态 | 说明 |
|------|------|
| `pending` | 等待处理 |
| `processing` | 处理中 |
| `completed` | 处理完成 |
| `failed` | 处理失败 |

---

#### 3.2 获取文档列表

获取指定知识库的所有文档。

**端点**: `GET /api/v1/knowledge/bases/{kb_id}/documents`

**权限要求**: 已登录用户（仅限知识库创建者）

**路径参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| `kb_id` | string | 知识库 ID |

**响应示例**:

```json
[
  {
    "id": "880e8400-e29b-41d4-a716-446655440003",
    "knowledge_base_id": "770e8400-e29b-41d4-a716-446655440002",
    "filename": "Python基础教程.pdf",
    "file_type": "pdf",
    "file_size": 1048576,
    "chunk_count": 42,
    "upload_status": "completed",
    "error_message": null,
    "uploaded_at": "2026-01-29T10:40:00",
    "processed_at": "2026-01-29T10:40:15"
  },
  {
    "id": "990e8400-e29b-41d4-a716-446655440004",
    "knowledge_base_id": "770e8400-e29b-41d4-a716-446655440002",
    "filename": "Docker使用指南.docx",
    "file_type": "word",
    "file_size": 524288,
    "chunk_count": 28,
    "upload_status": "completed",
    "error_message": null,
    "uploaded_at": "2026-01-29T09:30:00",
    "processed_at": "2026-01-29T09:30:10"
  }
]
```

**说明**: 结果按上传时间倒序排列。

---

#### 3.3 获取文档详情

获取指定文档的详细信息。

**端点**: `GET /api/v1/knowledge/bases/{kb_id}/documents/{doc_id}`

**权限要求**: 已登录用户（仅限知识库创建者）

**路径参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| `kb_id` | string | 知识库 ID |
| `doc_id` | string | 文档 ID |

**响应示例**:

```json
{
  "id": "880e8400-e29b-41d4-a716-446655440003",
  "knowledge_base_id": "770e8400-e29b-41d4-a716-446655440002",
  "filename": "Python基础教程.pdf",
  "file_type": "pdf",
  "file_size": 1048576,
  "chunk_count": 42,
  "upload_status": "completed",
  "error_message": null,
  "uploaded_at": "2026-01-29T10:40:00",
  "processed_at": "2026-01-29T10:40:15"
}
```

---

#### 3.4 删除文档

删除指定文档（同时删除向量数据和数据库记录）。

**端点**: `DELETE /api/v1/knowledge/bases/{kb_id}/documents/{doc_id}`

**权限要求**: 已登录用户（仅限知识库创建者）

**路径参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| `kb_id` | string | 知识库 ID |
| `doc_id` | string | 文档 ID |

**响应示例**:

```json
{
  "message": "文档已删除"
}
```

**说明**: 此操作会同时删除 ChromaDB 向量数据和 MySQL 数据库记录。

---

### 4. 切片管理

#### 4.1 获取文档切片列表

获取指定文档的所有切片（支持分页）。

**端点**: `GET /api/v1/knowledge/bases/{kb_id}/documents/{doc_id}/chunks`

**权限要求**: 已登录用户（仅限知识库创建者）

**路径参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| `kb_id` | string | 知识库 ID |
| `doc_id` | string | 文档 ID |

**查询参数**:

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `offset` | int | 否 | 0 | 偏移量 |
| `limit` | int | 否 | 无 | 返回数量限制（不传则返回全部） |

**响应示例**:

```json
{
  "document_id": "880e8400-e29b-41d4-a716-446655440003",
  "filename": "Python基础教程.pdf",
  "chunks": [
    {
      "id": "880e8400-e29b-41d4-a716-446655440003_chunk_0",
      "chunk_index": 0,
      "content": "Python 是一种高级编程语言，由 Guido van Rossum 于 1991 年首次发布...",
      "metadata": {
        "document_id": "880e8400-e29b-41d4-a716-446655440003",
        "knowledge_base_id": "770e8400-e29b-41d4-a716-446655440002",
        "user_id": "user-id-123",
        "filename": "Python基础教程.pdf",
        "file_type": "pdf",
        "source": "Python基础教程.pdf"
      }
    },
    {
      "id": "880e8400-e29b-41d4-a716-446655440003_chunk_1",
      "chunk_index": 1,
      "content": "Python 的设计哲学强调代码的可读性和简洁的语法...",
      "metadata": {
        "document_id": "880e8400-e29b-41d4-a716-446655440003",
        "knowledge_base_id": "770e8400-e29b-41d4-a716-446655440002",
        "user_id": "user-id-123",
        "filename": "Python基础教程.pdf",
        "file_type": "pdf",
        "source": "Python基础教程.pdf"
      }
    }
  ],
  "total_count": 42,
  "returned_count": 2,
  "offset": 0,
  "limit": 2
}
```

**说明**: 切片按 `chunk_index` 升序排列。

---

### 5. 知识检索

#### 5.1 语义搜索

基于向量相似度进行语义搜索，返回最相关的文档切片。

**端点**: `GET /api/v1/knowledge/search`

**权限要求**: 已登录用户

**查询参数**:

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `query` | string | 是 | - | 搜索查询文本（1-2000字符） |
| `knowledge_base_ids` | string | 否 | 用户所有知识库 | 逗号分隔的知识库 ID 列表 |
| `top_k` | int | 否 | 5 | 返回结果数量 |

**请求示例**:

```bash
GET /api/v1/knowledge/search?query=Python如何安装第三方库？&knowledge_base_ids=kb1,kb2&top_k=5
```

**响应示例**:

```json
{
  "results": [
    {
      "id": "880e8400-e29b-41d4-a716-446655440003_chunk_5",
      "content": "安装第三方库使用 pip 工具，pip 是 Python 的包管理器。打开终端或命令行，执行以下命令：pip install package_name。例如，安装 requests 库：pip install requests。",
      "metadata": {
        "document_id": "880e8400-e29b-41d4-a716-446655440003",
        "knowledge_base_id": "770e8400-e29b-41d4-a716-446655440002",
        "user_id": "user-id-123",
        "filename": "Python基础教程.pdf",
        "file_type": "pdf",
        "chunk_index": 5
      },
      "similarity": 0.892,
      "distance": 0.108
    },
    {
      "id": "990e8400-e29b-41d4-a716-446655440004_chunk_3",
      "content": "Python 包管理器 pip 通常随 Python 一起安装。你可以通过以下命令检查 pip 是否已安装：pip --version。如果未安装，可以从 python.org 下载安装包。",
      "metadata": {
        "document_id": "990e8400-e29b-41d4-a716-446655440004",
        "knowledge_base_id": "770e8400-e29b-41d4-a716-446655440002",
        "user_id": "user-id-123",
        "filename": "Docker使用指南.docx",
        "file_type": "word",
        "chunk_index": 3
      },
      "similarity": 0.856,
      "distance": 0.144
    }
  ],
  "query": "Python如何安装第三方库？",
  "total": 2
}
```

**搜索算法**:

1. **查询向量化**: 使用 BGE 模型将查询文本转换为向量
2. **向量检索**: 在 ChromaDB 中进行余弦相似度搜索
3. **结果排序**: 按相似度降序排列
4. **权限过滤**: 仅返回用户有权限访问的知识库内容

**相似度说明**:

| 相似度范围 | 说明 |
|-----------|------|
| 0.9 - 1.0 | 高度相关 |
| 0.7 - 0.9 | 相关 |
| 0.5 - 0.7 | 部分相关 |
| 0.0 - 0.5 | 不相关 |

**错误响应**:

- `400`: 查询内容为空 / 格式错误
- `403`: 无权访问某些知识库
- `500`: 检索失败

**特殊响应** (无知识库):

```json
{
  "results": [],
  "query": "搜索查询",
  "total": 0,
  "message": "暂无可搜索的知识库，请先创建知识库并上传文档"
}
```

---

## 数据模型

### KnowledgeGroup (知识库分组)

```typescript
{
  id: string;                  // UUID
  name: string;                // 分组名称（1-255字符）
  description?: string;        // 分组描述
  user_id: string;             // 创建者 ID
  color: string;               // 分组颜色（十六进制）
  created_at: DateTime;        // 创建时间
}
```

### KnowledgeBase (知识库)

```typescript
{
  id: string;                  // UUID
  name: string;                // 知识库名称（1-255字符）
  description?: string;        // 知识库描述
  user_id: string;             // 创建者 ID
  group_id?: string;           // 所属分组 ID（可为空）
  embedding_model: string;     // 向量化模型
  chunk_size: number;          // 分块大小（100-2000）
  chunk_overlap: number;       // 分块重叠（0-500）
  is_active: boolean;          // 是否启用
  document_count: number;      // 文档数量（已处理完成）
  created_at: DateTime;        // 创建时间
  updated_at: DateTime;        // 更新时间
}
```

### Document (文档)

```typescript
{
  id: string;                  // UUID
  knowledge_base_id: string;   // 所属知识库 ID
  filename: string;            // 文件名
  file_type?: string;          // 文件类型
  file_size?: number;          // 文件大小（字节）
  chunk_count: number;         // 切片数量
  upload_status: string;       // 上传状态
  error_message?: string;      // 错误信息
  uploaded_at: DateTime;       // 上传时间
  processed_at?: DateTime;     // 处理完成时间
}
```

### Chunk (文档切片)

```typescript
{
  id: string;                  // 切片 ID（格式: {doc_id}_chunk_{index}）
  chunk_index: number;         // 切片索引
  content: string;             // 切片内容
  metadata: {
    document_id: string;       // 文档 ID
    knowledge_base_id: string; // 知识库 ID
    user_id: string;           // 用户 ID
    filename: string;          // 文件名
    file_type: string;         // 文件类型
    source: string;            // 来源
  };
}
```

### SearchResult (搜索结果)

```typescript
{
  id: string;                  // 切片 ID
  content: string;             // 切片内容
  metadata: object;            // 元数据
  similarity: number;          // 相似度（0-1）
  distance: number;            // 距离（0-1）
}
```

---

## 错误码说明

### HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 413 | 文件过大 |
| 500 | 服务器内部错误 |

### 错误响应格式

```json
{
  "detail": "错误描述信息"
}
```

### 常见错误

| 错误信息 | 说明 | 解决方案 |
|----------|------|----------|
| 分组名称已存在 | 同一用户下分组名重复 | 使用不同的名称 |
| 知识库名称已存在 | 同一分组下知识库名重复 | 使用不同的名称 |
| 不支持的文件类型 | 文件扩展名不在白名单中 | 使用支持的文件格式 |
| 文件大小超过限制 | 文件超过 50MB | 压缩文件或拆分上传 |
| ChromaDB 连接失败 | 向量数据库不可用 | 检查 ChromaDB 服务状态 |
| 文档处理失败 | 文档解析或向量化失败 | 查看详细错误信息，检查文件格式 |

---

## 使用示例

### cURL 示例

#### 1. 创建知识库

```bash
curl -X POST http://localhost:18080/api/v1/knowledge/bases \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Python 入门指南",
    "description": "Python 编程基础知识",
    "chunk_size": 500,
    "chunk_overlap": 50
  }'
```

#### 2. 上传文档（同步模式）

```bash
curl -X POST http://localhost:18080/api/v1/knowledge/bases/{kb_id}/documents \
  -H "Authorization: Bearer <token>" \
  -F "file=@/path/to/document.pdf" \
  -F "sync=true"
```

#### 3. 语义搜索

```bash
curl -X GET "http://localhost:18080/api/v1/knowledge/search?query=Python如何安装第三方库？&top_k=5" \
  -H "Authorization: Bearer <token>"
```

### JavaScript (Fetch API)

#### 1. 创建知识库

```javascript
const response = await fetch('http://localhost:18080/api/v1/knowledge/bases', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    name: 'Python 入门指南',
    description: 'Python 编程基础知识',
    chunk_size: 500,
    chunk_overlap: 50
  })
});

const knowledgeBase = await response.json();
console.log(knowledgeBase);
```

#### 2. 上传文档

```javascript
const formData = new FormData();
formData.append('file', fileInput.files[0]);
formData.append('sync', 'true');

const response = await fetch(
  `http://localhost:18080/api/v1/knowledge/bases/${kbId}/documents`,
  {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  }
);

const document = await response.json();
console.log(document);
```

#### 3. 语义搜索

```javascript
const response = await fetch(
  `http://localhost:18080/api/v1/knowledge/search?query=${encodeURIComponent(query)}&top_k=5`,
  {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  }
);

const results = await response.json();
console.log(results);
```

### Python (requests)

#### 1. 创建知识库

```python
import requests

headers = {'Authorization': f'Bearer {token}'}
data = {
    'name': 'Python 入门指南',
    'description': 'Python 编程基础知识',
    'chunk_size': 500,
    'chunk_overlap': 50
}

response = requests.post(
    'http://localhost:18080/api/v1/knowledge/bases',
    headers=headers,
    json=data
)

knowledge_base = response.json()
print(knowledge_base)
```

#### 2. 上传文档

```python
import requests

headers = {'Authorization': f'Bearer {token}'}
files = {'file': open('document.pdf', 'rb')}
data = {'sync': 'true'}

response = requests.post(
    f'http://localhost:18080/api/v1/knowledge/bases/{kb_id}/documents',
    headers=headers,
    files=files,
    data=data
)

document = response.json()
print(document)
```

#### 3. 语义搜索

```python
import requests

headers = {'Authorization': f'Bearer {token}'}
params = {
    'query': 'Python如何安装第三方库？',
    'top_k': 5
}

response = requests.get(
    'http://localhost:18080/api/v1/knowledge/search',
    headers=headers,
    params=params
)

results = response.json()
print(results)
```

---

## 附录

### A. 支持的向量化模型

| 模型名称 | 维度 | 语言 | 说明 |
|----------|------|------|------|
| bge-large-zh-v1.5 | 1024 | 中文 | 中文大型模型，默认推荐 |
| bge-small-zh-v1.5 | 512 | 中文 | 中文小型模型，速度更快 |
| paraphrase-multilingual-MiniLM-L12-v2 | 384 | 多语言 | 多语言轻量级模型 |

### B. 文本分割器配置

默认分隔符（按优先级排序）:

```
["\n\n", "\n", "。", "！", "？", ".", "!", "?", " ", ""]
```

分割策略:
- 优先使用段落分隔符 (`\n\n`)
- 其次使用句子分隔符（中文句号、英文句号）
- 最后按字符分割

### C. 相似度计算

使用余弦相似度 (Cosine Similarity):

```
similarity = 1 - distance
```

其中 `distance` 为 ChromaDB 返回的余弦距离。

### D. 性能优化建议

1. **分批上传**: 对于大量文档，建议分批上传（每批 10-20 个文档）
2. **同步模式**: 小文件（< 5MB）建议使用同步模式，大文件使用异步模式
3. **chunk_size 调整**:
   - 短文档（如 FAQ）: 200-300
   - 中等文档（如文章）: 500-700
   - 长文档（如书籍）: 800-1000
4. **重试机制**: 文档处理支持自动重试（最多 3 次）

### E. 安全性说明

1. **文件验证**:
   - 扩展名白名单检查
   - 魔术字节（Magic Bytes）验证
   - 文件大小限制（50MB）
2. **路径遍历防护**: 所有文件名都经过安全处理
3. **权限隔离**: 用户只能访问自己创建的知识库

### F. 故障排查

#### ChromaDB 连接失败

```bash
# 检查 ChromaDB 容器状态
docker ps | grep chromadb

# 查看 ChromaDB 日志
docker logs bright-chat-chromadb

# 重启 ChromaDB
docker restart bright-chat-chromadb
```

#### BGE 模型加载失败

```bash
# 检查模型文件
ls -la /data1/allresearchProject/Bright-Chat/models/

# 手动下载模型
cd backend-python
python download_model.py
```

#### 文档处理卡住

```bash
# 查看后端日志
docker logs -f AIWorkbench-backend

# 检查文档处理状态
curl http://localhost:18080/api/v1/knowledge/bases/{kb_id}/documents
```

---

## 更新日志

### v1.0.0 (2026-01-29)

- 初始版本发布
- 支持知识库分组管理
- 支持多种文档格式上传
- 支持同步和异步处理模式
- 支持语义检索
- 支持切片分页查询

---

## 技术支持

如有问题，请联系技术团队或提交 Issue。

---

**文档结束**
