# Bright-Chat 项目开发规则

本文档记录了项目开发中的重要规则和约定，所有开发者必须遵守。

## 🔒 数据库连接规则（最重要）

### ⚠️ Docker容器间通信规则

**核心原则：Docker容器内必须使用容器名称连接，严禁使用localhost**

#### 为什么不能用localhost？

在Docker网络中：
- `localhost` 指向容器自己，而不是其他容器
- 容器间通信必须使用**容器名称**（作为主机名）
- 使用localhost会导致连接失败

#### 不同场景的连接方式

| 场景 | 连接方式 | 示例 | 说明 |
|------|---------|------|------|
| **容器→容器** | 完整容器名称 | `DB_HOST=AIWorkbench-mysql` | Docker容器间通信使用完整容器名称 |
| **主机→容器** | localhost | `DB_HOST=localhost:13306` | 从宿主机访问容器暴露的端口 |
| **容器→外部服务** | 外部IP | `DB_HOST=47.116.218.206` | 连接宿主机上的外部服务 |

#### ⚠️ 容器命名规则

本项目使用统一的前缀命名所有容器：
```bash
AIWorkbench-mysql      # MySQL数据库
AIWorkbench-redis      # Redis缓存
AIWorkbench-chromadb   # ChromaDB向量数据库
AIWorkbench-backend    # 后端API服务
AIWorkbench-frontend   # 前端应用
AIWorkbench-nginx      # Nginx反向代理
```

**重要**：容器间通信必须使用**完整容器名称**，不能使用简称：
```bash
# ✅ 正确
DB_HOST=AIWorkbench-mysql
REDIS_HOST=AIWorkbench-redis
CHROMADB_HOST=AIWorkbench-chromadb

# ❌ 错误（这些是docker-compose服务名，不是容器名）
DB_HOST=mysql
REDIS_HOST=redis
CHROMADB_HOST=chromadb
```

#### 当前项目配置

**Docker内部服务连接（backend/.env 或 docker-compose.yml）：**
```bash
# ✅ 正确：使用完整容器名称
DB_HOST=AIWorkbench-mysql
DB_PORT=3306
REDIS_HOST=AIWorkbench-redis
REDIS_PORT=6379
CHROMADB_HOST=AIWorkbench-chromadb
CHROMADB_PORT=8000
```

**从主机访问（开发调试）：**
```bash
# ✅ 正确：使用localhost + 暴露端口
mysql -h localhost -P 13306 -u root -p
curl http://localhost:18080/health
```

#### ❌ 常见错误

```bash
# ❌ 错误：在容器内使用localhost
DB_HOST=localhost  # 这会连接到容器自己，而不是MySQL容器
DB_PORT=3306

# ❌ 错误：使用docker-compose服务名（不是容器名）
DB_HOST=mysql  # 服务名不是容器名，DNS无法解析

# ❌ 错误：使用127.0.0.1
DB_HOST=127.0.0.1  # 同样会连接到容器自己
```

#### 验证方法

在容器内测试连接：
```bash
# 进入后端容器
docker exec -it AIWorkbench-backend bash

# 测试MySQL连接
docker exec AIWorkbench-backend python -c "
import pymysql
conn = pymysql.connect(
    host='AIWorkbench-mysql',  # ✅ 使用完整容器名称
    port=3306,
    user='root',
    password='root_password_change_me',
    database='bright_chat'
)
print('连接成功！')
"
```

### 🔐 密码哈希规则

**所有用户密码必须使用bcrypt哈希，严禁使用其他哈希算法**

#### 为什么必须用bcrypt？

- bcrypt专为密码设计，自带salt
- SHA256/MD5等通用哈希不适合密码存储
- 使用错误格式会导致 `ValueError: Invalid salt` 错误

#### 正确的密码格式

```python
# ✅ 正确：bcrypt格式（60字符）
$2b$12$rN8KLe8dk0MyR.U9j7681OXAnqB4Qp0zztHAk4P3S5WTydeV38diu

# ❌ 错误：SHA256格式（64字符）
8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918

# ❌ 错误：MD5格式（32字符）
5f4dcc3b5aa765d61d8327deb882cf99
```

#### 密码哈希生成

```python
import bcrypt

# 生成哈希
password = "user_password"
salt = bcrypt.gensalt()
hashed = bcrypt.hashpw(password.encode('utf-8'), salt).decode('utf-8')

# 验证密码
is_valid = bcrypt.checkpw(password.encode('utf-8'), hashed.encode('utf-8'))
```

#### 数据库字段定义

```sql
CREATE TABLE users (
    password_hash VARCHAR(255) NOT NULL  -- bcrypt哈希需要60字符
);
```

## 🐳 Docker服务管理

### 服务启动顺序

```bash
# 1. 启动基础服务（数据库、缓存）
docker-compose up -d mysql redis chromadb

# 2. 等待服务就绪（健康检查通过）
docker ps  # 查看所有服务状态

# 3. 启动应用服务
docker-compose up -d backend

# 4. 启动前端和代理
docker-compose up -d frontend nginx
```

### 健康检查

```bash
# 检查MySQL
docker exec AIWorkbench-mysql mysqladmin ping -u root -p'root_password_change_me'

# 检查后端API
curl http://localhost:18080/health

# 检查所有服务状态
docker ps
```

## 📝 代码规范

### Python代码

- 使用bcrypt处理密码，不使用其他哈希库
- 数据库连接使用连接池
- 环境变量统一在.env文件中管理
- 敏感信息禁止硬编码

### 环境变量管理

```bash
# 后端容器环境变量（docker-compose.yml）
DB_HOST=mysql              # 容器名称
DB_PORT=3306               # 容器内部端口
DB_USERNAME=root
DB_PASSWORD=root_password_change_me
```

```bash
# 主机访问（.env文件）
DB_HOST=localhost          # 从主机访问
DB_PORT=13306              # 暴露到主机的端口
```

## 🚨 常见问题排查

### 问题1：后端无法连接数据库

**症状：**
```
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError)
(2003, "Can't connect to MySQL server on 'mysql'")
```

**排查步骤：**
1. 检查MySQL容器是否运行：`docker ps | grep mysql`
2. 检查网络配置：`docker network inspect bright-chat_AIWorkbench-network`
3. 检查环境变量：`docker exec AIWorkbench-backend env | grep DB_HOST`
4. 测试连接：`docker exec AIWorkbench-backend ping mysql`

**解决方案：**
- 确保`.env`文件中`DB_HOST=AIWorkbench-mysql`（使用完整容器名，不是localhost或mysql）
- 确保所有容器在同一个Docker网络中
- 重启后端服务

### 问题2：登录报错 ValueError: Invalid salt

**症状：**
```
ValueError: Invalid salt
File "/app/minimal_api.py", line 76, in verify_password
    return bcrypt.checkpw(
```

**排查步骤：**
1. 检查密码哈希格式：
```sql
SELECT username, password_hash, CHAR_LENGTH(password_hash) FROM users;
```

2. 检查哈希类型：
```bash
# ✅ bcrypt: 60字符，以$2b$或$2a$开头
# ❌ SHA256: 64字符，纯十六进制
# ❌ MD5: 32字符，纯十六进制
```

**解决方案：**
```python
# 重新生成正确的bcrypt哈希
import bcrypt
hashed = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
```

### 问题3：容器间网络不通

**症状：**
- ping容器名称失败
- 连接超时

**解决方案：**
```bash
# 确保容器在同一网络
docker network connect bright-chat_AIWorkbench-network AIWorkbench-backend

# 重启容器
docker restart AIWorkbench-backend
```

## ✅ 检查清单

在提交代码或部署前，必须确认：

- [ ] 所有数据库连接使用容器名称（不是localhost）
- [ ] 所有密码使用bcrypt哈希格式
- [ ] 所有容器在同一个Docker网络中
- [ ] 环境变量正确配置
- [ ] 服务健康检查通过
- [ ] 测试登录功能正常

## 📚 相关文档

- [Docker网络文档](https://docs.docker.com/network/)
- [bcrypt文档](https://pypi.org/project/bcrypt/)
- [docker-compose.yml](./docker-compose.yml)
- [部署指南](./DEPLOYMENT_GUIDE.md)

---

**最后更新：** 2026-01-26
**维护者：** Bright-Chat 开发团队
